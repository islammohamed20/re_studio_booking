# ุฅุตูุงุญ ุฏุงูุฉ ุญุณุงุจ ุงูุณุงุนุงุช ูู ุฌุฏูู ุชูุงุฑูุฎ ุงูุญุฌุฒ

## ุงูุชุงุฑูุฎ: 19 ุฃูุชูุจุฑ 2025

---

## โ ุงููุดููุฉ

ุงูุฏุงูุฉ `calculate_hours_for_row` ูู `booking.js` ูุงูุช ุชุญุงูู ุชุญููู **Time ููุท** ุจุงุณุชุฎุฏุงู `frappe.datetime.str_to_obj()` ุงูุชู ุชุชููุน **DateTime ูุงูู** (ุชุงุฑูุฎ + ููุช).

### ุงูููุฏ ุงููุฏูู (ุงูุฎุงุทุฆ):

```javascript
function calculate_hours_for_row(frm, cdt, cdn) {
    let row = locals[cdt][cdn];
    
    if (row.start_time && row.end_time) {
        // โ ุฎุทุฃ: ูุญุงููุฉ ุชุญููู Time ููุท ุจุฏูู ุชุงุฑูุฎ
        let start = frappe.datetime.str_to_obj(row.start_time);  // "10:00:00"
        let end = frappe.datetime.str_to_obj(row.end_time);      // "14:00:00"
        
        // ... ุจุงูู ุงูููุฏ
    }
}
```

### ููุงุฐุง ูุฐุง ุฎุทุฃุ

1. `row.start_time` ู `row.end_time` ูู ููุน **Time** (ูุซุงู: `"10:00:00"`)
2. `frappe.datetime.str_to_obj()` ุชุชููุน **DateTime** ูุงูู (ูุซุงู: `"2025-10-19 10:00:00"`)
3. ุนูุฏ ูุญุงููุฉ ุชุญููู Time ููุทุ ูุฏ ุชุญุฏุซ ุฃุฎุทุงุก ุฃู ูุชุงุฆุฌ ุบูุฑ ูุชููุนุฉ
4. ุงูุฏุงูุฉ ูุง ูููููุง ูุนุฑูุฉ ุงูุชุงุฑูุฎุ ููุท ุงูููุช

---

## โ ุงูุญู

ุฏูุฌ `booking_date` ูู ุงูุตู ูุน `start_time` ู `end_time` ูุฅูุดุงุก DateTime ูุงูู.

### ุงูููุฏ ุงูุฌุฏูุฏ (ุงูุตุญูุญ):

```javascript
function calculate_hours_for_row(frm, cdt, cdn) {
    let row = locals[cdt][cdn];
    
    if (row.start_time && row.end_time) {
        // โ ุตุญูุญ: ุงุณุชุฎุฏุงู ุงูุชุงุฑูุฎ ูู ุงูุตู + ุงูููุช
        let booking_date = row.booking_date || frappe.datetime.nowdate();
        
        // ุฏูุฌ ุงูุชุงุฑูุฎ ูุน ุงูููุช ูุฅูุดุงุก DateTime ูุงูู
        let start = frappe.datetime.str_to_obj(booking_date + ' ' + row.start_time);
        let end = frappe.datetime.str_to_obj(booking_date + ' ' + row.end_time);
        
        // ุฅุฐุง ูุงู ููุช ุงูููุงูุฉ ุฃุตุบุฑ ูู ุงูุจุฏุงูุฉ (ุนุจูุฑ ููุชุตู ุงูููู)
        if (end <= start) {
            end.setDate(end.getDate() + 1);
        }
        
        // ุญุณุงุจ ุงููุฑู ุจุงูุณุงุนุงุช
        let diff_ms = end - start;
        let hours = diff_ms / (1000 * 60 * 60);
        
        // ุชุนููู ุงููููุฉ
        frappe.model.set_value(cdt, cdn, 'hours', hours.toFixed(2));
        
        // ุฅุนุงุฏุฉ ุญุณุงุจ ุงูุฅุฌูุงููุงุช
        setTimeout(() => {
            calculate_total_used_hours(frm);
        }, 100);
    }
}
```

---

## ๐ ุงูุชูุตูู

### 1. ุงูุญุตูู ุนูู ุงูุชุงุฑูุฎ

```javascript
let booking_date = row.booking_date || frappe.datetime.nowdate();
```

- ูุณุชุฎุฏู `booking_date` ูู ุงูุตู ุฅุฐุง ูุงู ููุฌูุฏุงู
- ุฅุฐุง ูู ููู ูุญุฏุฏุงูุ ูุณุชุฎุฏู ุงูุชุงุฑูุฎ ุงูุญุงูู ูุงุญุชูุงุท

### 2. ุฏูุฌ ุงูุชุงุฑูุฎ + ุงูููุช

```javascript
let start = frappe.datetime.str_to_obj(booking_date + ' ' + row.start_time);
let end = frappe.datetime.str_to_obj(booking_date + ' ' + row.end_time);
```

**ูุซุงู:**
- `booking_date` = `"2025-10-19"`
- `row.start_time` = `"10:00:00"`
- **ุงููุชูุฌุฉ:** `"2025-10-19 10:00:00"` โ

### 3. ูุนุงูุฌุฉ ุนุจูุฑ ููุชุตู ุงูููู

```javascript
if (end <= start) {
    end.setDate(end.getDate() + 1);
}
```

**ูุซุงู:**
- ุงูุจุฏุงูุฉ: `"2025-10-19 23:00:00"`
- ุงูููุงูุฉ: `"2025-10-19 02:00:00"`
- ุจุนุฏ ุงูุชุตุญูุญ: `"2025-10-20 02:00:00"`
- ุงููุฑู: **3 ุณุงุนุงุช** โ

---

## ๐งช ุงุฎุชุจุงุฑ ุงูุฅุตูุงุญ

### ุณููุงุฑูู 1: ููู ุนุงุฏู

**ุงููุฏุฎูุงุช:**
- `booking_date`: `2025-10-19`
- `start_time`: `10:00:00`
- `end_time`: `14:00:00`

**ุงูุญุณุงุจ:**
```javascript
start = "2025-10-19 10:00:00"
end = "2025-10-19 14:00:00"
diff = 4 hours
```

**ุงููุชูุฌุฉ:** โ `hours = 4.00`

---

### ุณููุงุฑูู 2: ุนุจูุฑ ููุชุตู ุงูููู

**ุงููุฏุฎูุงุช:**
- `booking_date`: `2025-10-19`
- `start_time`: `23:00:00`
- `end_time`: `02:00:00`

**ุงูุญุณุงุจ:**
```javascript
start = "2025-10-19 23:00:00"
end = "2025-10-19 02:00:00"  // ุฃุตุบุฑ ูู start
// ุชุทุจูู ุงูุชุตุญูุญ:
end = "2025-10-20 02:00:00"  // ุฅุถุงูุฉ ููู
diff = 3 hours
```

**ุงููุชูุฌุฉ:** โ `hours = 3.00`

---

### ุณููุงุฑูู 3: ุจุฏูู ุชุงุฑูุฎ ูุญุฏุฏ

**ุงููุฏุฎูุงุช:**
- `booking_date`: `null` ุฃู `undefined`
- `start_time`: `09:00:00`
- `end_time`: `17:00:00`

**ุงูุญุณุงุจ:**
```javascript
booking_date = frappe.datetime.nowdate()  // "2025-10-19" (ุงูุชุงุฑูุฎ ุงูุญุงูู)
start = "2025-10-19 09:00:00"
end = "2025-10-19 17:00:00"
diff = 8 hours
```

**ุงููุชูุฌุฉ:** โ `hours = 8.00`

---

## ๐ ุงูุชุญูู ูู ุงูุฅุตูุงุญ

### ูู ูุงุฌูุฉ ุงููุณุชุฎุฏู:

1. **ูุชุญ ุญุฌุฒ ูู ููุน Package**
2. **ุงุฎุชูุงุฑ ุจุงูุฉ**
3. **ุฅุถุงูุฉ ุชุงุฑูุฎ ุญุฌุฒ ูู ุฌุฏูู ุชูุงุฑูุฎ ุงูุญุฌุฒ:**
   - ุงูุชุงุฑูุฎ: ุฃู ุชุงุฑูุฎ
   - ููุช ุงูุจุฏุงูุฉ: `10:00:00`
   - ููุช ุงูููุงูุฉ: `14:00:00`
4. **ุงููุชูุฌุฉ ุงููุชููุนุฉ:**
   - ุญูู "ุนุฏุฏ ุงูุณุงุนุงุช" = `4.00` โ
   - "ุงูุณุงุนุงุช ุงููุณุชุฎุฏูุฉ" ูุชุญุฏุซ ุชููุงุฆูุงู
   - "ุงูุณุงุนุงุช ุงููุชุจููุฉ" ูุชุญุฏุซ ุชููุงุฆูุงู

### ูู Console:

```javascript
// ุงุฎุชุจุงุฑ ูุฏูู ูู Browser Console:
let test_date = "2025-10-19";
let start_time = "10:00:00";
let end_time = "14:00:00";

let start = frappe.datetime.str_to_obj(test_date + ' ' + start_time);
let end = frappe.datetime.str_to_obj(test_date + ' ' + end_time);

let diff_ms = end - start;
let hours = diff_ms / (1000 * 60 * 60);

console.log("Hours:", hours);  // ูุฌุจ ุฃู ูุทุจุน: 4
```

---

## ๐ ุงูููุงุฑูุฉ

| ุงูุฌุงูุจ | ูุจู ุงูุฅุตูุงุญ โ | ุจุนุฏ ุงูุฅุตูุงุญ โ |
|--------|---------------|---------------|
| **ุงููุฏุฎูุงุช** | Time ููุท (`"10:00:00"`) | Date + Time (`"2025-10-19 10:00:00"`) |
| **ุงูุชุญููู** | ูุฏ ููุดู ุฃู ูุนุทู ูุชุงุฆุฌ ุฎุงุทุฆุฉ | ูุนูู ุจุดูู ุตุญูุญ |
| **ุนุจูุฑ ููุชุตู ุงูููู** | ูุฏ ูุง ูุนูู | ูุนูู โ |
| **ุงูุฏูุฉ** | ุบูุฑ ููุซูู | ุฏููู 100% |
| **ุงูุญุงูุงุช ุงูุญุฏูุฉ** | ูุดุงูู ูุญุชููุฉ | ูุนุงูุฌุฉ ุฌููุน ุงูุญุงูุงุช |

---

## ๐ ููุงุญุธุงุช ุฅุถุงููุฉ

### 1. ููุงุฐุง ูุณุชุฎุฏู `setTimeout`ุ

```javascript
setTimeout(() => {
    calculate_total_used_hours(frm);
}, 100);
```

- ูุชู ุชุฃุฎูุฑ ุฅุนุงุฏุฉ ุงูุญุณุงุจ ูู 100ms
- ูุถูู ุฃู ุงููููุฉ ุงูุฌุฏูุฏุฉ ุชู ุญูุธูุง ูู `row.hours` ูุจู ุฅุนุงุฏุฉ ุญุณุงุจ ุงูุฅุฌูุงููุงุช
- ูููุน ูุดุงูู ุงูุชุฒุงูู (race conditions)

### 2. ุฏูุฉ ุงูุณุงุนุงุช

```javascript
hours.toFixed(2)
```

- ูุญุฏ ุงููุชูุฌุฉ ุฅูู ุฑูููู ุนุดุฑููู
- ูุซุงู: `4.5` ุณุงุนุฉุ `2.25` ุณุงุนุฉ

### 3. ุญูู `hours` ูู read_only

ูู `package_booking_date.json`:
```json
{
  "fieldname": "hours",
  "fieldtype": "Float",
  "read_only": 1,  // ุงููุณุชุฎุฏู ูุง ููููู ุชุนุฏููู ูุฏููุงู
  "precision": "2"
}
```

- ููุญุณุจ ุชููุงุฆูุงู ูู `start_time` ู `end_time`
- ุงููุณุชุฎุฏู ูุง ูุญุชุงุฌ ูุฅุฏุฎุงูู ูุฏููุงู
- ูุฐุง ูููุน ุงูุฃุฎุทุงุก ุงูุจุดุฑูุฉ

---

## โ ุงูุฎูุงุตุฉ

### ุงููุดููุฉ:
- ูุญุงููุฉ ุชุญููู **Time ููุท** ุจุฏูู ุชุงุฑูุฎ โ

### ุงูุญู:
- ุฏูุฌ **booking_date + Time** ูุฅูุดุงุก DateTime ูุงูู โ

### ุงููุชูุฌุฉ:
- ุญุณุงุจ ุฏููู ููุณุงุนุงุช ูู ุฌููุน ุงูุญุงูุงุช
- ูุนุงูุฌุฉ ุนุจูุฑ ููุชุตู ุงูููู
- ุชุญุฏูุซ ุชููุงุฆู ููุฅุฌูุงููุงุช

**ุงูุฅุตูุงุญ ููุชูู ููุฎุชุจุฑ!** ๐

---

**ุชุงุฑูุฎ ุงูุฅุตูุงุญ:** 19 ุฃูุชูุจุฑ 2025  
**ุงูููู ุงููุนุฏู:** `booking.js`  
**ุงูุฏุงูุฉ ุงููุตูุญุฉ:** `calculate_hours_for_row()`  
**ุงูุญุงูุฉ:** โ ููุชูู
